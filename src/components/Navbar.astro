---
import { Icon } from "astro-icon/components";
import { navBarConfig, siteConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import { LinkPreset, type NavBarLink } from "../types/config";
import { url } from "../utils/url-utils";

import Search from "./Search.svelte";
import DisplaySettings from "./widget/DisplaySettings.svelte";
import NavMenuPanel from "./widget/NavMenuPanel.astro";
const className = Astro.props.class;

const resolveLink = (item: NavBarLink | LinkPreset): NavBarLink => {
	if (typeof item === "number") {
		return LinkPresets[item];
	}
	const children = item.children?.map(resolveLink);
	return children ? { ...item, children } : item;
};

let links: NavBarLink[] = navBarConfig.links.map(resolveLink);
---
<div id="navbar" class="z-50 onload-animation">
	<div class="absolute h-8 left-0 right-0 -top-8 bg-[var(--card-bg)] transition"></div> <!-- used for onload animation -->
	<div class:list={[
		className,
		"card-base border border-black/10 dark:border-white/10 !overflow-visible max-w-[var(--page-width)] h-[4.5rem] !rounded-t-none mx-auto flex items-center justify-between px-4"]}>
		<a href={url('/')} class="btn-plain scale-animation rounded-lg h-[3.25rem] px-5 font-bold active:scale-95">
			<div class="flex flex-row text-[var(--primary)] items-center text-md">
				<Icon name="material-symbols:home-outline-rounded" class="text-[1.75rem] mb-1 mr-2" />
				{siteConfig.title}
			</div>
		</a>
		<div class="hidden md:flex items-center space-x-1">
			{links.map((l) => {
				const children = l.children ?? [];
				if (children.length > 0) {
					return (
						<div class="nav-dropdown">
							<button
								class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 flex items-center"
								aria-haspopup="true"
								aria-expanded="false"
								type="button"
							>
								<span>{l.name}</span>
								<Icon
									name="material-symbols:keyboard-arrow-down-rounded"
									class="text-[1.25rem] ml-1 transition-transform duration-200 nav-dropdown-arrow"
								/>
							</button>
							<div class="nav-dropdown-menu" role="menu">
								<div class="nav-dropdown-panel">
									{children.map((child) => (
										<a
											href={child.external ? child.url : url(child.url)}
											target={child.external ? "_blank" : null}
											rel={child.external ? "noopener noreferrer" : null}
											class="nav-dropdown-item"
											role="menuitem"
										>
											<span>{child.name}</span>
											{child.external && (
												<Icon
													name="fa6-solid:arrow-up-right-from-square"
													class="text-[0.75rem] text-black/25 dark:text-white/25 ml-2"
												/>
											)}
										</a>
									))}
								</div>
							</div>
						</div>
					);
				}
				return (
					<a
						aria-label={l.name}
						href={l.external ? l.url : url(l.url)}
						target={l.external ? "_blank" : null}
						class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95"
					>
						<div class="flex items-center">
							{l.name}
							{l.external && (
								<Icon
									name="fa6-solid:arrow-up-right-from-square"
									class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]"
								/>
							)}
						</div>
					</a>
				);
			})}
		</div>
		<div class="flex">
			<!--<SearchPanel client:load>-->
			<Search client:only="svelte"></Search>
			{!siteConfig.themeColor.fixed && (
						<button aria-label="Display Settings" class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="display-settings-switch">
							<Icon name="material-symbols:palette-outline" class="text-[1.25rem]"></Icon>
						</button>
			)}

			<button aria-label="Menu" name="Nav Menu" class="btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 md:!hidden" id="nav-menu-switch">
				<Icon name="material-symbols:menu-rounded" class="text-[1.25rem]"></Icon>
			</button>
		</div>
		<NavMenuPanel links={links}></NavMenuPanel>
		<DisplaySettings client:only="svelte"></DisplaySettings>
	</div>
</div>

<script>
function loadButtonScript() {

	let settingBtn = document.getElementById("display-settings-switch");
	if (settingBtn) {
		settingBtn.onclick = function () {
			let settingPanel = document.getElementById("display-setting");
			if (settingPanel) {
				settingPanel.classList.toggle("float-panel-closed");
			}
		};
	}

	let menuBtn = document.getElementById("nav-menu-switch");
	if (menuBtn) {
		menuBtn.onclick = function () {
			let menuPanel = document.getElementById("nav-menu-panel");
			if (menuPanel) {
				menuPanel.classList.toggle("float-panel-closed");
			}
		};
	}
}

loadButtonScript();
</script>

<style>
	.nav-dropdown {
		position: relative;
	}

	.nav-dropdown-menu {
		position: absolute;
		left: 0;
		top: 100%;
		padding-top: 0.5rem;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-8px);
		pointer-events: none;
		transition: all 0.2s ease;
		z-index: 50;
	}

	.nav-dropdown:hover .nav-dropdown-menu,
	.nav-dropdown:focus-within .nav-dropdown-menu {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
		pointer-events: auto;
	}

	.nav-dropdown:hover .nav-dropdown-arrow,
	.nav-dropdown:focus-within .nav-dropdown-arrow {
		transform: rotate(180deg);
	}

	.nav-dropdown-panel {
		background: var(--float-panel-bg);
		border: 1px solid rgba(0, 0, 0, 0.08);
		border-radius: 0.75rem;
		box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
		padding: 0.5rem;
		min-width: 10rem;
	}

	:root.dark .nav-dropdown-panel {
		border-color: rgba(255, 255, 255, 0.1);
		box-shadow: none;
	}

	.nav-dropdown-item {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.5rem;
		padding: 0.5rem 0.75rem;
		border-radius: 0.5rem;
		color: rgba(0, 0, 0, 0.7);
		font-weight: 600;
		transition: color 0.15s ease, background-color 0.15s ease;
		white-space: nowrap;
	}

	:root.dark .nav-dropdown-item {
		color: rgba(255, 255, 255, 0.7);
	}

	.nav-dropdown-item:hover {
		color: var(--primary);
		background: var(--btn-plain-bg-hover);
	}
</style>
